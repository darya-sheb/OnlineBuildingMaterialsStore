{% extends "base.html" %}

{% block title %}Корзина - СтройМаг{% endblock %}

{% block content %}
<h2>Ваша корзина</h2>

<div id="cart-content">
    <p>Загрузка...</p>
</div>

<script>
async function loadCart() {
    try {
        const response = await fetch('/cart/', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Ошибка загрузки');
        }

        const data = await response.json();
        renderCart(data);
    } catch (error) {
        document.getElementById('cart-content').innerHTML = '<p class="alert alert-error">Не удалось загрузить корзину</p>';
        console.error('Cart load error:', error);
    }
}

function renderCart(data) {
    const container = document.getElementById('cart-content');
    
    if (!data.items || data.items.length === 0) {
        container.innerHTML = '<p>Ваша корзина пуста :(</p><a href="/products/catalog">Перейти в каталог</a>';
        return;
    }

    let html = `
        <table class="table">
            <thead>
                <tr>
                    <th>Товар</th>
                    <th>Цена</th>
                    <th>Кол-во</th>
                    <th>Итого</th>
                    <th>Действие</th>
                </tr>
            </thead>
            <tbody>
    `;

    data.items.forEach(item => {
        html += `
            <tr>
                <td>${item.name}</td>
                <td>${item.price} руб</td>
                <td>
                    <input type="number" value="${item.quantity}" min="1" 
                           data-item-id="${item.cart_item_id}" class="cart-quantity">
                </td>
                <td>${item.total.toFixed(2)} руб</td>
                <td>
                    <button class="btn btn-custom remove-item" data-item-id="${item.cart_item_id}">Удалить</button>
                </td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
        <h3>Итого: ${data.total_price.toFixed(2)} руб</h3>
        <a href="/orders/checkout" class="btn btn-custom">Оформить заказ</a>
    `;

    container.innerHTML = html;

    document.querySelectorAll('.cart-quantity').forEach(input => {
        input.addEventListener('change', updateQuantity);
    });
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', removeItem);
    });
}

async function updateQuantity(e) {
    const itemId = e.target.dataset.itemId;
    const quantity = e.target.value;
    
    const response = await fetch(`/cart/items/${itemId}`, {
        method: 'PUT',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity: parseInt(quantity) })
    });
    
    if (response.ok) {
        loadCart();
    }
}

async function removeItem(e) {
    const itemId = e.target.dataset.itemId;
    
    const response = await fetch(`/cart/items/${itemId}`, {
        method: 'DELETE',
        credentials: 'include'
    });
    
    if (response.ok) {
        loadCart();
    }
}

document.addEventListener('DOMContentLoaded', loadCart);
</script>

{% endblock %}
